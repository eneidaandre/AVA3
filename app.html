<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVA3 • Meus Cursos</title>
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link rel="stylesheet" href="./assets/css/chrome.css">
    <link rel="stylesheet" href="./assets/css/site.css">
</head>
<body class="has-sidebar">

    <div id="site-header"></div>
    <div id="site-sidebar"></div>

    <main class="container">
        <div class="section-header" style="margin-top: 20px;">
            <div class="section-title">
                <h2>Meus Cursos</h2>
                <p>Continue de onde parou</p>
            </div>
        </div>

        <div class="class-grid" id="my-courses-list">
            <div style="text-align: center; grid-column: 1/-1; padding: 40px;">
                <i class='bx bx-loader-alt bx-spin' style="font-size: 2rem; color: #ccc;"></i>
            </div>
        </div>
    </main>

    <div id="site-footer"></div>

    <script type="module" src="./assets/js/chrome.js"></script>
    <script type="module">
        import { supabase } from './assets/js/supabaseClient.js';

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }

            const container = document.getElementById('my-courses-list');
            
            const { data: enrollments, error } = await supabase
                .from('class_enrollments')
                .select(`*, classes (id, name, courses (title))`)
                .eq('user_id', session.user.id);

            container.innerHTML = '';

            if (error || !enrollments || enrollments.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 50px; background: white; border-radius: 12px; border: 1px dashed #ccc;">
                        <h3>Você ainda não tem cursos.</h3>
                        <a href="index.html" class="btn-enroll" style="width: auto; padding: 10px 30px; display:inline-block; margin-top:10px;">Ver Turmas</a>
                    </div>`;
                return;
            }

            enrollments.forEach(enroll => {
                const cls = enroll.classes;
                const completed = enroll.grades?.completed?.length || 0;
                const progressWidth = Math.min(100, completed * 5); // Estimativa visual

                const html = `
                    <article class="course-card">
                        <div class="card-header-img"><i class='bx bx-book-bookmark'></i></div>
                        <div class="card-body">
                            <div class="badge-course">${cls.name}</div>
                            <h3 class="card-title">${cls.courses?.title || 'Curso'}</h3>
                            
                            <div class="card-meta">
                                <div class="progress-info">
                                    <span>Progresso</span>
                                    <span class="text-bold">${completed} lições</span>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: ${progressWidth}%"></div>
                                </div>
                            </div>

                            <div class="card-footer">
                                <a href="classroom.html?id=${cls.id}" class="btn-enroll">
                                    Continuar
                                </a>
                            </div>
                        </div>
                    </article>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        });
    </script>
</body>
</html>