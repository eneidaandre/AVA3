<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVA3 • Meus Cursos</title>
    
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link rel="stylesheet" href="./assets/css/chrome.css">
    <link rel="stylesheet" href="./assets/css/site.css"> </head>
<body class="has-sidebar">

    <div id="site-header"></div>
    <div id="site-sidebar"></div>

    <main class="container">
        
        <div class="section-header" style="margin-top: 20px;">
            <div class="section-title">
                <h2>Meus Cursos</h2>
                <p>Continue de onde parou</p>
            </div>
        </div>

        <div class="class-grid" id="my-courses-list">
            <div style="text-align: center; grid-column: 1/-1; padding: 40px;">
                <i class='bx bx-loader-alt bx-spin' style="font-size: 2rem; color: #ccc;"></i>
                <p class="mt-2 text-muted">Carregando seus cursos...</p>
            </div>
        </div>

    </main>

    <div id="site-footer"></div>

    <script type="module" src="./assets/js/chrome.js"></script>
    <script type="module">
        import { supabase } from './assets/js/supabaseClient.js';

        // Script inline simples para carregar cursos
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }

            const container = document.getElementById('my-courses-list');
            
            // Busca matrículas
            const { data: enrollments, error } = await supabase
                .from('class_enrollments')
                .select(`
                    *,
                    classes (
                        id, name, 
                        courses (title)
                    )
                `)
                .eq('user_id', session.user.id);

            container.innerHTML = '';

            if (error || !enrollments || enrollments.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 50px; background: white; border-radius: 12px; border: 1px dashed #ccc;">
                        <h3>Você ainda não tem cursos.</h3>
                        <p>Vá para a página inicial e inscreva-se em uma turma.</p>
                        <a href="index.html" class="btn-enroll" style="width: auto; padding: 10px 30px;">Ver Turmas</a>
                    </div>`;
                return;
            }

            // Renderiza Cards
            enrollments.forEach(enroll => {
                const cls = enroll.classes;
                // Calcula progresso (baseado no array completed)
                const completed = enroll.grades?.completed?.length || 0;
                // Nota: O total de aulas precisaria ser buscado, aqui vamos estimar ou usar o campo salvo se tiver
                // Para simplificar visualmente:
                const progressWidth = Math.min(100, completed * 5); // Exemplo visual

                const html = `
                    <article class="course-card">
                        <div class="card-header-img">
                            <i class='bx bx-book-bookmark'></i>
                        </div>
                        <div class="card-body">
                            <div class="badge-course">${cls.courses?.title || 'Curso'}</div>
                            <h3 class="card-title">${cls.name}</h3>
                            
                            <div class="card-meta">
                                <div class="d-flex justify-content-between align-items-center w-100">
                                    <small>Progresso</small>
                                    <small class="fw-bold">${completed} lições</small>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: ${progressWidth}%"></div>
                                </div>
                            </div>

                            <div class="card-footer">
                                <a href="class-dashboard.html?id=${cls.id}" class="btn-enroll">
                                    Continuar Estudando
                                </a>
                            </div>
                        </div>
                    </article>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        });
    </script>
</body>
</html>